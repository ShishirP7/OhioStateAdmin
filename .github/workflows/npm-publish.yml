name: üöÄ Deploy Frontend with Nginx Auto-Reload
on:
  push:
    branches: [main]
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.css"
      - "next.config.js"
      - "package.json"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üîê SSH Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 1. Setup environment
            FRONTEND_DIR="/var/www/ohio-state-admin"
            cd ~

            # 2. Atomic deployment
            if [ -d "$FRONTEND_DIR" ]; then
              echo "üîÑ Updating existing deployment..."
              cd $FRONTEND_DIR
              git fetch --all
              git reset --hard origin/main
            else
              echo "üì¶ Fresh installation..."
              git clone https://github.com/ShishirP7/OhioStateAdmin.git $FRONTEND_DIR
              cd $FRONTEND_DIR
            fi

            # 3. Build process
            npm ci
            npm run build

            # 4. PM2 management
            pm2 restart next-frontend --update-env || \
            pm2 start "npm run start" --name next-frontend

            # 5. Conditional Nginx reload
            if git diff --name-only HEAD~1 HEAD | grep -q 'next.config.js'; then
              echo "üîß Detected frontend config change - reloading Nginx"
              sudo nginx -t && sudo systemctl reload nginx
            fi

            # 6. Verification
            echo "‚úÖ Deployment status:"
            curl -Is http://localhost:3000 | head -n 1
            pm2 list
