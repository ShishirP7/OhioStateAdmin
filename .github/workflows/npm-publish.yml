name: Deploy Frontend
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            REPO_DIR="/var/www/ohio-state-admin"
            REPO_URL="https://github.com/ShishirP7/OhioStateAdmin.git"
            PM2_APP_NAME="next-admin"
            
            # Clone or update repository
            if [ ! -d "$REPO_DIR" ]; then
              echo "Setting up fresh installation..."
              sudo mkdir -p /var/www
              git clone "$REPO_URL" "$REPO_DIR"
            else
              echo "Updating existing installation..."
              cd "$REPO_DIR"
              git reset --hard
              git clean -fd
              git pull origin main
            fi
            
            # Install dependencies and build
            cd "$REPO_DIR"
            npm ci --omit=dev
            npm run build
            
            # Start/Restart PM2 process
            if pm2 list | grep -q "$PM2_APP_NAME"; then
              pm2 restart "$PM2_APP_NAME"
            else
              pm2 start "npm run start" --name "$PM2_APP_NAME"
              pm2 save
              pm2 startup
            fi
            
            # Verify and restart nginx
            sudo nginx -t && sudo systemctl reload nginx
            echo "Deployment completed successfully"